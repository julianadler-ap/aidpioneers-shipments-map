<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aid Pioneers Shipments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />

  <style>
    /* ===== Layout (full bleed, no sidebar) ===== */
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; background: #02060c; }

    #mapWrap { position: fixed; inset: 0; }

    /* “space” outside the globe (matches your styled vibe) */
    #mapWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(120,170,255,0.18) 0%, rgba(0,0,0,0) 40%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0) 45%),
        radial-gradient(circle at 50% 50%, #0b223b 0%, #05101f 60%, #02060c 100%);
      z-index: 0;
    }

    /* subtle stars */
    #mapWrap::after{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle, rgba(255,255,255,0.35) 1px, transparent 2px) 0 0/120px 120px,
        radial-gradient(circle, rgba(255,255,255,0.25) 1px, transparent 2px) 40px 60px/180px 180px;
      opacity: 0.22;
      pointer-events:none;
      z-index: 1;
    }

    #map { position: absolute; inset: 0; z-index: 2; }

    /* vignette overlay */
    .vignette{
      pointer-events: none;
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse at 65% 45%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.0) 40%),
        radial-gradient(ellipse at 65% 60%, rgba(0,0,0,0.0) 40%, rgba(0,0,0,0.40) 75%, rgba(0,0,0,0.78) 100%);
      z-index: 5;
    }

    /* ===== Popups (from your reference) ===== */
    .mapboxgl-popup{ z-index:3000!important; border-radius:20px; overflow:hidden; }
    .mapboxgl-popup-content{
      font:13px/1.5 "Inter", Arial, sans-serif;
      padding:18px 20px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      animation:popupFade .25s ease-out;
      color:#0F2C4C !important;
    }
    .mapboxgl-popup-close-button,.mapboxgl-popup-tip{ display:none; }
    @keyframes popupFade{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
    .hover-tip .mapboxgl-popup-content{ padding:6px 10px; font-weight:600; border-radius:12px; }

    /* ===== Markers (from your reference) ===== */
    .marker{
      background: rgba(226,0,116,.40);
      border-radius: 50%;
      box-sizing: content-box;
      cursor: pointer;
      transform: translate(-50%, -100%);
      transition: transform 0.2s ease-out; /* smooth hover scale */
      border: 2px solid #fff;
    }
    .mapboxgl-marker:hover{
      transform: translate(-50%, -100%) scale(1.3);
    }
    .marker.is-hovered{
      box-shadow:0 0 0 9999px rgba(230,138,167,.35);
    }

    /* ===== NO UI / NO MENU ===== */
    /* Hide all Mapbox controls if Mapbox injects any */
    .mapboxgl-ctrl-top-right,
    .mapboxgl-ctrl-top-left,
    .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-bottom-left{
      display:none !important;
    }

    /* Optional: hide attribution/logo (Mapbox TOS may require attribution) */
    .mapboxgl-ctrl-attrib { display:none !important; }
    a.mapboxgl-ctrl-logo  { display:none !important; }
  </style>
</head>

<body>
  <div id="mapWrap">
    <div id="map"></div>
    <div class="vignette"></div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script>
    /*****************************************************************
      CONFIG
    *****************************************************************/
    mapboxgl.accessToken = 'pk.eyJ1IjoianVsaWFuYWRsZXIiLCJhIjoiY21jZXkxcG55MDMwajJ3c2N5MDFvcjFxYSJ9.1CXb3-6uyCagAxGvpWf4iA';

    // Your desired basemap style
    const STYLE = 'mapbox://styles/lillysturz/cmcdif4wb00ty01sb0z5yf7bk';

    // Your shipments GeoJSON
    const DATA_URL = 'https://raw.githubusercontent.com/julianadler-ap/aidpioneers-shipments-map/main/combined.geojson';

    /*****************************************************************
      MAP INIT (globe, no controls)
    *****************************************************************/
    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      projection: 'globe',
      center: [10, 20],
      zoom: 1.1,
      bearing: 0,
      pitch: 0,
      attributionControl: false,
      preserveDrawingBuffer: true
    });

    // Fog to merge globe into “space”
    map.on('style.load', () => {
      try {
        map.setFog({
          range: [0.8, 8],
          color: 'rgba(210, 230, 255, 0.08)',
          'high-color': 'rgba(150, 190, 255, 0.06)',
          'space-color': '#02060c',
          'horizon-blend': 0.10
        });
      } catch (_) {}
    });

    /*****************************************************************
      MARKER SIZING (zoom-based)
    *****************************************************************/
    const markers = [];

    function updateMarkerSizes(){
      const zoom = map.getZoom();
      // similar feel to your reference scaling
      const scale = Math.max(0.3, Math.min(2, Math.pow(zoom / 3.5, 2.5)));
      markers.forEach(m => {
        const el = m.getElement();
        const base = 12; // px
        const size = base * scale;
        el.style.width = `${size}px`;
        el.style.height = `${size}px`;
      });
    }

    /*****************************************************************
      Hover tooltip (like your reference)
    *****************************************************************/
    let hoverPopup = null;

    function addHoverToMarker(el, label, marker){
      el.addEventListener('mouseenter', () => {
        if (hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          className: 'hover-tip',
          offset: 10
        })
          .setLngLat(marker.getLngLat())
          .setHTML(label)
          .addTo(map);
      });

      el.addEventListener('mouseleave', () => {
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });

      el.addEventListener('click', () => {
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });
    }

    /*****************************************************************
      Build routes from POINT rows (same logic as your shipments map)
    *****************************************************************/
    function buildLineFeatures(geojson){
      const routesByContainer = {};
      for (const f of (geojson.features || [])) {
        const p = f.properties || {};
        if (p['Row Type'] !== 'POINT') continue;
        if (p['API Status'] && p['API Status'] !== 'success') continue;

        const container = p['Container Number'];
        if (!container) continue;

        (routesByContainer[container] ||= []).push({
          leg: Number(p['Leg #']),
          coord: f.geometry?.coordinates
        });
      }

      const lineFeatures = [];
      for (const container of Object.keys(routesByContainer)) {
        const pts = routesByContainer[container]
          .filter(x => Array.isArray(x.coord) && x.coord.length === 2)
          .sort((a, b) => (!isNaN(a.leg) && !isNaN(b.leg)) ? a.leg - b.leg : 0)
          .map(x => x.coord);

        if (pts.length > 1) {
          lineFeatures.push({
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: pts },
            properties: { container }
          });
        }
      }

      return { type: 'FeatureCollection', features: lineFeatures };
    }

    /*****************************************************************
      Fit to all points (prevents “only Ukraine”)
    *****************************************************************/
    function fitToAllPoints(geojson){
      const bounds = new mapboxgl.LngLatBounds();
      for (const f of (geojson.features || [])) {
        if (f.geometry?.type === 'Point' && Array.isArray(f.geometry.coordinates)) {
          bounds.extend(f.geometry.coordinates);
        }
      }
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 80, maxZoom: 2.2, duration: 1200 });
      }
    }

    /*****************************************************************
      LOAD + DRAW
    *****************************************************************/
    map.on('load', () => {
      fetch(`${DATA_URL}?t=${Date.now()}`)
        .then(r => { if (!r.ok) throw new Error(`GeoJSON fetch failed (${r.status})`); return r.json(); })
        .then(geojson => {
          // Add lines via Mapbox layer (fast)
          const lineFC = buildLineFeatures(geojson);
          map.addSource('shipment-lines', { type: 'geojson', data: lineFC });
          map.addLayer({
            id: 'shipment-lines-layer',
            type: 'line',
            source: 'shipment-lines',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
              'line-color': '#0F2C4C',
              'line-width': ['interpolate', ['linear'], ['zoom'], 1, 1.2, 3, 2.2, 6, 3.6],
              'line-opacity': 0.70
            }
          });

          // Add points as *custom HTML markers* (to match your CSS marker look exactly)
          const pointFeatures = (geojson.features || []).filter(f => f.properties?.['Row Type'] === 'POINT');

          for (const f of pointFeatures) {
            const coords = f.geometry?.coordinates;
            if (!Array.isArray(coords) || coords.length !== 2) continue;

            const p = f.properties || {};
            const label = `Container ${p['Container Number'] || '—'} · Leg ${p['Leg #'] || '—'}`;

            const el = document.createElement('div');
            el.className = 'marker';
            el.style.width = el.style.height = '12px';

            const popupHtml = `
              <div>
                <strong>Shipment Point</strong><hr class="sep">
                <b>Container:</b> ${p['Container Number'] || '-'}<br>
                <b>Leg #:</b> ${p['Leg #'] || '-'}<br>
                <b>Status:</b> ${p['API Status'] || '-'}
              </div>
            `;

            const marker = new mapboxgl.Marker(el)
              .setLngLat(coords)
              .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml))
              .addTo(map);

            addHoverToMarker(el, label, marker);
            markers.push(marker);
          }

          // Auto fit to show global network
          fitToAllPoints(geojson);

          // Initial sizing + resize hooks
          updateMarkerSizes();
          map.on('zoom', updateMarkerSizes);
          window.addEventListener('resize', () => map.resize());
        })
        .catch(console.error);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aid Pioneers Shipments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; background: #02060c; }

    /* Full-bleed */
    #mapWrap{
      position: fixed;
      inset: 0;
      overflow: hidden;

      /* “space” behind the globe */
      background:
        radial-gradient(circle at 30% 30%, rgba(120,170,255,0.18) 0%, rgba(0,0,0,0) 40%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0) 45%),
        radial-gradient(circle at 50% 50%, #0b223b 0%, #05101f 60%, #02060c 100%);
    }

    /* subtle star field */
    #mapWrap::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle, rgba(255,255,255,0.35) 1px, transparent 2px) 0 0/120px 120px,
        radial-gradient(circle, rgba(255,255,255,0.25) 1px, transparent 2px) 40px 60px/180px 180px;
      opacity: 0.22;
      pointer-events:none;
      z-index: 1;
    }

    /* Map sits on top */
    #map { position: absolute; inset: 0; z-index: 2; }

    /* vignette to match the styled reference */
    .vignette{
      pointer-events: none;
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse at 65% 45%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.0) 40%),
        radial-gradient(ellipse at 65% 60%, rgba(0,0,0,0.0) 40%, rgba(0,0,0,0.40) 75%, rgba(0,0,0,0.78) 100%);
      z-index: 5;
    }

    /* Popups */
    .mapboxgl-popup{ z-index:3000!important; border-radius:20px; overflow:hidden; }
    .mapboxgl-popup-content{
      font:13px/1.5 system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      padding:18px 20px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      color:#0F2C4C !important;
      animation: popupFade .25s ease-out;
    }
    .mapboxgl-popup-close-button, .mapboxgl-popup-tip{ display:none; }
    @keyframes popupFade{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
    .hover-tip .mapboxgl-popup-content{ padding:6px 10px; font-weight:800; border-radius:12px; }

    /* Hide ALL Mapbox UI controls (the “menu”) */
    .mapboxgl-ctrl-top-right,
    .mapboxgl-ctrl-top-left,
    .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-bottom-left{
      display:none !important;
    }

    /* Also hide the attribution/logo if it appears (note: Mapbox TOS may require attribution) */
    .mapboxgl-ctrl-attrib { display:none !important; }
    a.mapboxgl-ctrl-logo { display:none !important; }
  </style>
</head>

<body>
  <div id="mapWrap">
    <div id="map"></div>
    <div class="vignette"></div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoianVsaWFuYWRsZXIiLCJhIjoiY21jZXkxcG55MDMwajJ3c2N5MDFvcjFxYSJ9.1CXb3-6uyCagAxGvpWf4iA';

    const STYLE = 'mapbox://styles/lillysturz/cmcdif4wb00ty01sb0z5yf7bk';
    const DATA_URL = 'https://raw.githubusercontent.com/julianadler-ap/aidpioneers-shipments-map/main/combined.geojson';

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      projection: 'globe',

      // Camera tuned for “big cropped globe”
      center: [25, 20],
      zoom: 1.85,
      bearing: -12,
      pitch: 0,

      attributionControl: false
    });

    map.on('style.load', () => {
      try {
        map.setFog({
          range: [0.8, 8],
          color: 'rgba(210, 230, 255, 0.08)',
          'high-color': 'rgba(150, 190, 255, 0.06)',
          'space-color': '#02060c',
          'horizon-blend': 0.10
        });
      } catch (_) {}
    });

    // Hover tooltip
    let hoverPopup = null;
    function attachHoverToLayer(layerId, getHtml) {
      map.on('mousemove', layerId, (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0];
        if (!f) return;

        if (hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          className: 'hover-tip',
          offset: 10
        })
          .setLngLat(e.lngLat)
          .setHTML(getHtml(f))
          .addTo(map);
      });

      map.on('mouseleave', layerId, () => {
        map.getCanvas().style.cursor = '';
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });
    }

    map.on('load', () => {
      fetch(`${DATA_URL}?t=${Date.now()}`)
        .then(r => { if (!r.ok) throw new Error(`GeoJSON fetch failed (${r.status})`); return r.json(); })
        .then(geojson => {
          map.addSource('shipments', { type: 'geojson', data: geojson });

          // Points
          map.addLayer({
            id: 'shipment-points',
            type: 'circle',
            source: 'shipments',
            filter: ['==', ['get', 'Row Type'], 'POINT'],
            paint: {
              'circle-radius': ['interpolate', ['linear'], ['zoom'], 1, 3, 3, 6, 6, 9],
              'circle-color': 'rgba(226, 0, 116, 0.70)',
              'circle-stroke-width': 1.6,
              'circle-stroke-color': '#ffffff'
            }
          });

          // Lines per container from points
          const routesByContainer = {};
          for (const f of geojson.features || []) {
            const p = f.properties || {};
            if (p['Row Type'] !== 'POINT') continue;
            if (p['API Status'] && p['API Status'] !== 'success') continue;

            const c = p['Container Number'];
            if (!c) continue;

            (routesByContainer[c] ||= []).push({
              leg: Number(p['Leg #']),
              coord: f.geometry?.coordinates
            });
          }

          const lineFeatures = [];
          for (const container of Object.keys(routesByContainer)) {
            const pts = routesByContainer[container]
              .filter(x => Array.isArray(x.coord) && x.coord.length === 2)
              .sort((a, b) => (!isNaN(a.leg) && !isNaN(b.leg)) ? a.leg - b.leg : 0)
              .map(x => x.coord);

            if (pts.length > 1) {
              lineFeatures.push({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: pts },
                properties: { container }
              });
            }
          }

          map.addSource('shipment-lines', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: lineFeatures }
          });

          map.addLayer({
            id: 'shipment-lines-layer',
            type: 'line',
            source: 'shipment-lines',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
              'line-color': '#0F2C4C',
              'line-width': ['interpolate', ['linear'], ['zoom'], 1, 1.2, 3, 2.2, 6, 3.6],
              'line-opacity': 0.70
            }
          });

          // Click popup
          map.on('click', 'shipment-points', (e) => {
            const f = e.features && e.features[0];
            if (!f) return;

            const p = f.properties || {};
            const html = `
              <div style="min-width:220px;">
                <div style="font-weight:800;margin-bottom:6px;">Shipment Point</div>
                <div><b>Container:</b> ${p['Container Number'] || '-'}</div>
                <div><b>Leg #:</b> ${p['Leg #'] || '-'}</div>
                <div><b>Status:</b> ${p['API Status'] || '-'}</div>
              </div>
            `;
            new mapboxgl.Popup({ offset: 25 })
              .setLngLat(e.lngLat)
              .setHTML(html)
              .addTo(map);
          });

          // Hover tooltip
          attachHoverToLayer('shipment-points', (f) => {
            const p = f.properties || {};
            return `Container ${p['Container Number'] || '—'} · Leg ${p['Leg #'] || '—'}`;
          });
        })
        .catch(console.error);
    });
  </script>
</body>
</html>

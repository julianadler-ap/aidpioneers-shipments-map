<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aid Pioneers Shipments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL CSS -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    // 1) Mapbox Token eintragen
    mapboxgl.accessToken = 'pk.eyJ1IjoianVsaWFuYWRsZXIiLCJhIjoiY21jZXkxcG55MDMwajJ3c2N5MDFvcjFxYSJ9.1CXb3-6uyCagAxGvpWf4iA';

    // 2) Karte initialisieren
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11', // oder dein eigener Style
      center: [10, 20],
      zoom: 2
    });

    // 3) GeoJSON von GitHub laden (deine combined.geojson)
    const DATA_URL =
      'https://raw.githubusercontent.com/julianadler-ap/aidpioneers-shipments-map/main/combined.geojson';

    map.on('load', () => {
      fetch(DATA_URL)
        .then(resp => resp.json())
        .then(geojson => {
          // Punkte aus GeoJSON nehmen
          map.addSource('shipments', {
            type: 'geojson',
            data: geojson
          });

          // Punkt-Layer
          map.addLayer({
            id: 'shipment-points',
            type: 'circle',
            source: 'shipments',
            paint: {
              'circle-radius': 4,
              'circle-color': '#e53935',
              'circle-stroke-width': 1,
              'circle-stroke-color': '#ffffff'
            }
          });

          // Linien pro Container aus den Punkten bauen
          const routesByContainer = {};
          geojson.features.forEach(f => {
            const props = f.properties || {};
            if (props['Row Type'] !== 'POINT') return;
            if (props['API Status'] && props['API Status'] !== 'success') return;

            const container = props['Container Number'];
            if (!container) return;

            if (!routesByContainer[container]) routesByContainer[container] = [];
            routesByContainer[container].push({
              leg: Number(props['Leg #']),
              coord: f.geometry.coordinates
            });
          });

          const lineFeatures = [];
          Object.keys(routesByContainer).forEach(container => {
            const pts = routesByContainer[container]
              .filter(p => Array.isArray(p.coord) && p.coord.length === 2)
              .sort((a, b) =>
                (!isNaN(a.leg) && !isNaN(b.leg))
                  ? a.leg - b.leg
                  : 0
              )
              .map(p => p.coord);

            if (pts.length > 1) {
              lineFeatures.push({
                type: 'Feature',
                geometry: {
                  type: 'LineString',
                  coordinates: pts
                },
                properties: { container }
              });
            }
          });

          map.addSource('shipment-lines', {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: lineFeatures
            }
          });

          map.addLayer({
            id: 'shipment-lines-layer',
            type: 'line',
            source: 'shipment-lines',
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#1565c0',
              'line-width': [
                'interpolate',
                ['linear'],
                ['zoom'],
                2, 1.5,
                4, 2,
                6, 3,
                8, 4
              ],
              'line-opacity': 0.75
            }
          });

          // Karte auf alle Punkte zoomen
          const bounds = new mapboxgl.LngLatBounds();
          geojson.features.forEach(f => {
            if (f.geometry &&
                f.geometry.type === 'Point' &&
                Array.isArray(f.geometry.coordinates)) {
              bounds.extend(f.geometry.coordinates);
            }
          });
          if (!bounds.isEmpty()) {
            map.fitBounds(bounds, { padding: 40 });
          }
        })
        .catch(err => {
          console.error('Error loading GeoJSON', err);
        });
    });
  </script>
</body>
</html>

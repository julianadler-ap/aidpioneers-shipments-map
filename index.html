<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aid Pioneers Shipments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />

  <style>
    /* ============================================================
       FULLSCREEN MAP PAGE (no sidebar/menu)
    ============================================================ */
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; background: #061325; }

    #mapWrap{
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: #061325;
    }

    /* BLUE space gradient BEHIND the globe */
    #mapWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 35%, rgba(120,170,255,0.35) 0%, rgba(0,0,0,0) 45%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(circle at 50% 55%, #163a63 0%, #0b223b 55%, #061325 100%);
      z-index: 0;
    }

    #map{
      position:absolute;
      inset:0;
      z-index: 2;
    }

    /* Soft vignette overlay (matches "glowy globe" feel) */
    .vignette{
      pointer-events:none;
      position:absolute; inset:0;
      z-index: 5;
      background:
        radial-gradient(ellipse at 65% 45%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.0) 40%),
        radial-gradient(ellipse at 65% 60%, rgba(0,0,0,0.0) 40%, rgba(0,0,0,0.35) 75%, rgba(0,0,0,0.65) 100%);
    }

    /* ============================================================
       POPUPS (clean, rounded)
    ============================================================ */
    .mapboxgl-popup{ z-index:3000!important; border-radius:20px; overflow:hidden; }
    .mapboxgl-popup-content{
      font:13px/1.5 "Inter", Arial, sans-serif;
      padding:18px 20px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      animation:popupFade .25s ease-out;
      color:#0F2C4C !important;
    }
    .mapboxgl-popup-close-button,.mapboxgl-popup-tip{ display:none; }
    @keyframes popupFade{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
    .hover-tip .mapboxgl-popup-content{
      padding:6px 10px;
      font-weight:600;
      border-radius:12px;
      white-space: nowrap;
    }

    /* ============================================================
       MARKERS (pink dots)
    ============================================================ */
    .marker{
      background: rgba(226,0,116,.40);
      border-radius: 50%;
      box-sizing: content-box;
      cursor: pointer;
      transform: translate(-50%, -100%);
      transition: transform 0.2s ease-out;
      border: 2px solid #fff;
    }
    .mapboxgl-marker:hover{
      transform: translate(-50%, -100%) scale(1.28);
    }
    .marker.is-hovered{
      box-shadow: 0 0 0 9999px rgba(230,138,167,.28);
    }

    /* ============================================================
       NO MAP UI (no buttons, no scale, no zoom, etc.)
    ============================================================ */
    .mapboxgl-ctrl-top-right,
    .mapboxgl-ctrl-top-left,
    .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-bottom-left{
      display:none !important;
    }

    /* Optional: hide attribution/logo (Mapbox ToS may require attribution) */
    .mapboxgl-ctrl-attrib { display:none !important; }
    a.mapboxgl-ctrl-logo  { display:none !important; }

    /* ============================================================
       BUILD STAMP (proof that the new file is deployed)
    ============================================================ */
    #buildStamp{
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 999999;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,44,76,.85);
      color: #fff;
      font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      letter-spacing: .2px;
      user-select: none;
    }
  </style>
</head>

<body>
  <div id="mapWrap">
    <div id="map"></div>
    <div class="vignette"></div>
    <div id="buildStamp">Build: v2025-12-05</div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script>
    /*****************************************************************
      CONFIG
    *****************************************************************/
    mapboxgl.accessToken =
      'pk.eyJ1IjoianVsaWFuYWRsZXIiLCJhIjoiY21jZXkxcG55MDMwajJ3c2N5MDFvcjFxYSJ9.1CXb3-6uyCagAxGvpWf4iA';

    // Use the style you want:
    // const STYLE = 'mapbox://styles/lillysturz/cmcdif4wb00ty01sb0z5yf7bk';
    // you also shared this one earlier; switch if needed:
    const STYLE = 'mapbox://styles/lillysturz/cmcdif4wb00ty01sb0z5yf7bk';

    const DATA_URL =
      'https://raw.githubusercontent.com/julianadler-ap/aidpioneers-shipments-map/main/combined.geojson';

    /*****************************************************************
      MAP INIT
    *****************************************************************/
    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      projection: 'globe',
      center: [10, 20],
      zoom: 1.1,
      bearing: 0,
      pitch: 0,
      attributionControl: false,
      preserveDrawingBuffer: true
    });

    // Blue fog / "space-color" (works only if style supports fog; safe try/catch)
    map.on('style.load', () => {
      try {
        map.setFog({
          range: [0.8, 8],
          color: 'rgba(210, 230, 255, 0.10)',
          'high-color': 'rgba(170, 210, 255, 0.10)',
          'space-color': '#0b223b',     // BLUE outside of globe
          'horizon-blend': 0.12
        });
      } catch (e) {
        // some styles may not support fog; harmless
      }
    });

    /*****************************************************************
      HOVER TOOLTIP
    *****************************************************************/
    let hoverPopup = null;

    function addHoverToMarker(el, label, marker){
      el.addEventListener('mouseenter', () => {
        if (hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          className: 'hover-tip',
          offset: 10
        })
        .setLngLat(marker.getLngLat())
        .setHTML(label)
        .addTo(map);
      });

      el.addEventListener('mouseleave', () => {
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });

      el.addEventListener('click', () => {
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });
    }

    /*****************************************************************
      MARKERS (HTML)
    *****************************************************************/
    const markers = [];

    function updateMarkerSizes(){
      const zoom = map.getZoom();
      const scale = Math.max(0.35, Math.min(2.1, Math.pow(zoom / 3.5, 2.3)));
      const baseSize = 12; // px
      const size = baseSize * scale;

      for (const m of markers) {
        const el = m.getElement();
        el.style.width = `${size}px`;
        el.style.height = `${size}px`;
      }
    }

    /*****************************************************************
      ROUTES: build LineStrings per "Container Number"
    *****************************************************************/
    function buildLineFeatures(geojson){
      const grouped = {};
      for (const f of (geojson.features || [])) {
        const p = f.properties || {};
        if (p['Row Type'] !== 'POINT') continue;
        if (p['API Status'] && p['API Status'] !== 'success') continue;

        const container = p['Container Number'];
        if (!container) continue;

        (grouped[container] ||= []).push({
          leg: Number(p['Leg #']),
          coord: f.geometry?.coordinates
        });
      }

      const features = [];
      for (const container of Object.keys(grouped)) {
        const pts = grouped[container]
          .filter(x => Array.isArray(x.coord) && x.coord.length === 2)
          .sort((a, b) => (!isNaN(a.leg) && !isNaN(b.leg)) ? a.leg - b.leg : 0)
          .map(x => x.coord);

        if (pts.length > 1) {
          features.push({
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: pts },
            properties: { container }
          });
        }
      }

      return { type: 'FeatureCollection', features };
    }

    /*****************************************************************
      FIT CAMERA (global network)
    *****************************************************************/
    function fitToAllPoints(geojson){
      const bounds = new mapboxgl.LngLatBounds();
      for (const f of (geojson.features || [])) {
        if (f.geometry?.type === 'Point' && Array.isArray(f.geometry.coordinates)) {
          bounds.extend(f.geometry.coordinates);
        }
      }
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 80, maxZoom: 2.2, duration: 1200 });
      }
    }

    /*****************************************************************
      LOAD + DRAW
    *****************************************************************/
    map.on('load', () => {
      fetch(`${DATA_URL}?t=${Date.now()}`)
        .then(r => { if (!r.ok) throw new Error(`GeoJSON fetch failed (${r.status})`); return r.json(); })
        .then(geojson => {

          // --- Routes
          const lineFC = buildLineFeatures(geojson);
          map.addSource('shipment-lines', { type: 'geojson', data: lineFC });

          map.addLayer({
            id: 'shipment-lines-layer',
            type: 'line',
            source: 'shipment-lines',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
              'line-color': '#0F2C4C',
              'line-width': ['interpolate', ['linear'], ['zoom'], 1, 1.15, 3, 2.1, 6, 3.4],
              'line-opacity': 0.70
            }
          });

          // --- Points
          const pointFeatures = (geojson.features || []).filter(f => (f.properties?.['Row Type'] === 'POINT'));

          for (const f of pointFeatures) {
            const coords = f.geometry?.coordinates;
            if (!Array.isArray(coords) || coords.length !== 2) continue;

            const p = f.properties || {};
            const container = p['Container Number'] || '—';
            const leg = p['Leg #'] || '—';

            const hoverLabel = `Container ${container} · Leg ${leg}`;

            const el = document.createElement('div');
            el.className = 'marker';
            el.style.width = el.style.height = '12px';

            const popupHtml = `
              <div>
                <strong>Shipment Point</strong><hr class="sep">
                <b>Container:</b> ${container}<br>
                <b>Leg #:</b> ${leg}<br>
                <b>Status:</b> ${p['API Status'] || '-'}
              </div>
            `;

            const marker = new mapboxgl.Marker(el)
              .setLngLat(coords)
              .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml))
              .addTo(map);

            addHoverToMarker(el, hoverLabel, marker);
            markers.push(marker);
          }

          // camera + responsive
          fitToAllPoints(geojson);
          updateMarkerSizes();

          map.on('zoom', updateMarkerSizes);
          window.addEventListener('resize', () => map.resize());
        })
        .catch(err => console.error(err));
    });
  </script>
</body>
</html>

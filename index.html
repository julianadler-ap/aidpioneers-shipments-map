<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aid Pioneers Shipments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />
  <style>
    html, body { height: 100%; margin: 0; background:#050f1c; }
    #mapWrap { position: relative; height: 100vh; width: 100vw; overflow: hidden; }
    #map { position: absolute; inset: 0; }

    /* Globe vignette (this is a big part of the “styled” look) */
    .vignette {
      pointer-events: none;
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse at 65% 45%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.0) 40%),
        radial-gradient(ellipse at 65% 60%, rgba(0,0,0,0.0) 40%, rgba(0,0,0,0.40) 75%, rgba(0,0,0,0.75) 100%);
      z-index: 5;
    }

    /* Popups (match your styled version) */
    .mapboxgl-popup { z-index:3000!important; border-radius:20px; overflow:hidden; }
    .mapboxgl-popup-content{
      font:13px/1.5 system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      padding:18px 20px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      color:#0F2C4C !important;
      animation: popupFade .25s ease-out;
    }
    .mapboxgl-popup-close-button, .mapboxgl-popup-tip { display:none; }
    @keyframes popupFade { from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
    .hover-tip .mapboxgl-popup-content { padding:6px 10px; font-weight:800; border-radius:12px; }

    /* Safety: avoid accidental page scrolling */
    body { overflow: hidden; }
  </style>
</head>

<body>
  <div id="mapWrap">
    <div id="map"></div>
    <div class="vignette"></div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoianVsaWFuYWRsZXIiLCJhIjoiY21jZXkxcG55MDMwajJ3c2N5MDFvcjFxYSJ9.1CXb3-6uyCagAxGvpWf4iA';

    const STYLE = 'mapbox://styles/lillysturz/cmcdif4wb00ty01sb0z5yf7bk';

    const DATA_URL =
      'https://raw.githubusercontent.com/julianadler-ap/aidpioneers-shipments-map/main/combined.geojson';

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      projection: 'globe',

      // Key to "big cropped globe" look:
      // Africa / MENA in view, globe filling most of frame.
      center: [25, 20],
      zoom: 1.85,
      bearing: -12,
      pitch: 0
    });

    map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl({ container: document.getElementById('mapWrap') }), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 140, unit: 'metric' }), 'bottom-right');

    // Hover tooltip
    let hoverPopup = null;
    function attachHoverToLayer(layerId, getHtml) {
      map.on('mousemove', layerId, (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0];
        if (!f) return;

        if (hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          className: 'hover-tip',
          offset: 10
        })
          .setLngLat(e.lngLat)
          .setHTML(getHtml(f))
          .addTo(map);
      });

      map.on('mouseleave', layerId, () => {
        map.getCanvas().style.cursor = '';
        if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
      });
    }

    map.on('style.load', () => {
      // Adds the “atmosphere” vibe (if the style already has fog, this is harmless)
      try {
        map.setFog({
          range: [0.8, 8],
          color: 'rgba(220, 235, 255, 0.10)',
          'high-color': 'rgba(150, 190, 255, 0.08)',
          'space-color': 'rgba(3, 10, 20, 1)',
          'horizon-blend': 0.12
        });
      } catch (_) {}
    });

    map.on('load', () => {
      fetch(`${DATA_URL}?t=${Date.now()}`)
        .then(r => { if (!r.ok) throw new Error(`GeoJSON fetch failed (${r.status})`); return r.json(); })
        .then(geojson => {
          map.addSource('shipments', { type: 'geojson', data: geojson });

          // POINTS
          map.addLayer({
            id: 'shipment-points',
            type: 'circle',
            source: 'shipments',
            filter: ['==', ['get', 'Row Type'], 'POINT'],
            paint: {
              'circle-radius': ['interpolate', ['linear'], ['zoom'], 1, 3, 3, 6, 6, 9],
              'circle-color': 'rgba(226, 0, 116, 0.70)',
              'circle-stroke-width': 1.6,
              'circle-stroke-color': '#ffffff'
            }
          });

          // LINES per Container Number from points
          const routesByContainer = {};
          for (const f of geojson.features || []) {
            const p = f.properties || {};
            if (p['Row Type'] !== 'POINT') continue;
            if (p['API Status'] && p['API Status'] !== 'success') continue;
            const c = p['Container Number'];
            if (!c) continue;
            (routesByContainer[c] ||= []).push({ leg: Number(p['Leg #']), coord: f.geometry?.coordinates });
          }

          const lineFeatures = [];
          for (const container of Object.keys(routesByContainer)) {
            const pts = routesByContainer[container]
              .filter(x => Array.isArray(x.coord) && x.coord.length === 2)
              .sort((a, b) => (!isNaN(a.leg) && !isNaN(b.leg)) ? a.leg - b.leg : 0)
              .map(x => x.coord);

            if (pts.length > 1) {
              lineFeatures.push({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: pts },
                properties: { container }
              });
            }
          }

          map.addSource('shipment-lines', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: lineFeatures }
          });

          map.addLayer({
            id: 'shipment-lines-layer',
            type: 'line',
            source: 'shipment-lines',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
              'line-color': '#0F2C4C',
              'line-width': ['interpolate', ['linear'], ['zoom'], 1, 1.2, 3, 2.2, 6, 3.6],
              'line-opacity': 0.70
            }
          });

          // Click popup
          map.on('click', 'shipment-points', (e) => {
            const f = e.features && e.features[0];
            if (!f) return;
            const p = f.properties || {};
            const html = `
              <div style="min-width:220px;">
                <div style="font-weight:800;margin-bottom:6px;">Shipment Point</div>
                <div><b>Container:</b> ${p['Container Number'] || '-'}</div>
                <div><b>Leg #:</b> ${p['Leg #'] || '-'}</div>
                <div><b>Status:</b> ${p['API Status'] || '-'}</div>
              </div>
            `;
            new mapboxgl.Popup({ offset: 25 }).setLngLat(e.lngLat).setHTML(html).addTo(map);
          });

          // Hover tooltip
          attachHoverToLayer('shipment-points', (f) => {
            const p = f.properties || {};
            return `Container ${p['Container Number'] || '—'} · Leg ${p['Leg #'] || '—'}`;
          });
        })
        .catch(console.error);
    });
  </script>
</body>
</html>
